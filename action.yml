name: "Vibranium Action"
description: "An action to read a JSON file and make an API call"
branding:
  color: "blue"
  icon: "shield"
inputs:
  file-path:
    description: "Path to the JSON file in the repository"
    required: true
  api-url:
    description: "The API endpoint to call"
    required: true
runs:
  using: "composite"
  steps:
    - name: Setup Python Environment
      run: |
        python -m venv .venv
        source .venv/bin/activate
        pip install requests
        pip install tabulate
      shell: bash
    - name: Run Python Script
      run: |
        python -c "
        import os
        import requests
        import json
        from tabulate import tabulate

        # Get environment variables
        file_path = os.getenv('INPUT_FILE_PATH')
        api_url = os.getenv('INPUT_API_URL')
        api_key = os.getenv('API_KEY')

        # Check if the file exists
        if not os.path.isfile(file_path):
            raise FileNotFoundError(f'The file {file_path} does not exist')

        # Read the file and send it to the API
        with open(file_path, 'rb') as file:
            data = json.load(file)
        
            # Linter
            spec_data = {
                "spec" : data
            }

            lint_response = requests.post('https://vibranium-api-guard.onrender.com/api/lint/linter',
                            json=spec_data)

            if lint_response.status_code == 200:
                print('Linting successful')
            elif lint_response.status_code == 400:
                print('Linting failed')
                # Log the response
                table_data = []
                for issue in lint_response.json():
                    path = " > ".join(issue["path"])
                    # Trim the path if it's too long
                    if len(path) > 20:
                        path = "..." + path[-(20 - 3):]
                    message = issue["message"]
                    line = issue["range"]["start"]["line"]
                    issue_type = issue["code"]
                    severity = issue["severity"]
                    table_data.append([path, severity, line, message])
                    
                # Print the table
                headers = ["Path", "Severity", "Line", "Message"]
                print(tabulate(table_data, headers, tablefmt="grid"))
                sys.exit(1) # Exit with error code 1 to indicate failure
            
            print("Ingesting APIs")
            headers = {'Authorization': f'Bearer {api_key}'}
            response = requests.post("https://vibranium-api-guard.onrender.com/api/endpoints/ingest", 
                      headers=headers, 
                      json=data)

        # Check the response
        if response.status_code == 200:
            print('Collection updated successfully')
        else:
            print(f'Failed to send file. Status code: {response.status_code}')
            print(f'Response: {response.text}')"
      shell: bash
      env:
        INPUT_FILE_PATH: ${{ inputs.file-path }}
        INPUT_API_URL: ${{ inputs.api-url }}
